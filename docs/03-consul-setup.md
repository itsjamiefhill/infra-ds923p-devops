# Consul Setup for Synology DS923+

This document provides detailed information about the Consul service discovery component of the HomeLab DevOps Platform on Synology DS923+.

## Overview

Consul is a service mesh solution that enables service discovery, configuration, and segmentation functionality for the platform. It acts as the backbone for service-to-service communication and provides key-value storage for configuration.

In the HomeLab DevOps Platform, Consul is the first service deployed because other components depend on it for:
- Service discovery
- Health checking
- DNS resolution
- Key-value storage
- Service metadata for the Homepage dashboard

## Architecture

The platform implements Consul in a simplified single-server mode appropriate for a Synology homelab environment:

- **Deployment Mode**: Single server with `-bootstrap` mode
- **Service Registration**: All platform services register with Consul
- **DNS Interface**: Provides service.consul domain resolution
- **UI**: Web interface for service management
- **Metadata**: Stores service metadata for Homepage dashboard integration

## Configuration

The Consul configuration is defined in `jobs/consul.hcl`, which is generated by the `03-deploy-consul.sh` script. Key configuration elements include:

| Parameter | Default Value | Description |
|-----------|---------------|-------------|
| HTTP Port | 8500 | Web UI and API |
| DNS Port | 8600 | DNS interface for service discovery |
| Server Port | 8300 | Server RPC |
| Serf LAN Port | 8301 | Gossip protocol for LAN |
| Serf WAN Port | 8302 | Gossip protocol for WAN |
| Bootstrap | true | Self-elect as cluster leader |
| UI | enabled | Web interface available |

## Data Persistence

Consul data is persisted on the Synology NAS using a Nomad volume:
- **Volume Name**: consul_data
- **Host Path**: `/volume1/docker/nomad/volumes/consul_data` (default)
- **Container Path**: `/consul/data`

This ensures that Consul's state, including service registrations and key-value pairs, is maintained across restarts and DSM updates.

## Technical Implementation

The Consul deployment is implemented as a Nomad job with a Docker driver. Here's the job definition structure:

```hcl
job "consul" {
  datacenters = ["dc1"]
  type = "service"

  group "consul" {
    count = 1

    network {
      port "http" {
        static = 8500
      }
      port "dns" {
        static = 8600
      }
      port "serf_lan" {
        static = 8301
      }
      port "serf_wan" {
        static = 8302
      }
      port "server" {
        static = 8300
      }
    }

    volume "consul_data" {
      type = "host"
      read_only = false
      source = "consul_data"
    }

    task "consul" {
      driver = "docker"

      volume_mount {
        volume = "consul_data"
        destination = "/consul/data"
        read_only = false
      }

      config {
        image = "hashicorp/consul:latest"
        ports = ["http", "dns", "serf_lan", "serf_wan", "server"]
        
        command = "agent"
        args = [
          "-server",
          "-bootstrap",
          "-ui",
          "-client=0.0.0.0",
          "-data-dir=/consul/data",
        ]
      }

      resources {
        cpu    = 500
        memory = 512
      }

      service {
        name = "consul"
        port = "http"
        
        tags = [
          "traefik.enable=true",
          "traefik.http.routers.consul.rule=Host(`consul.homelab.local`)",
          "traefik.http.routers.consul.tls=true",
          "homepage.name=Consul",
          "homepage.icon=consul.png",
          "homepage.group=Infrastructure",
          "homepage.description=Service discovery and key-value store"
        ]
        
        check {
          type     = "http"
          path     = "/v1/status/leader"
          interval = "10s"
          timeout  = "2s"
        }
      }
    }
  }
}
```

## Synology DNS Integration

One key feature for Synology is integrating Consul DNS with the Synology system for local service discovery.

The setup script adds Consul DNS integration by:

1. Creating a DNS configuration file for dnsmasq:
   ```bash
   mkdir -p /etc/dnsmasq.conf.d
   echo "server=/consul/127.0.0.1#8600" > /etc/dnsmasq.conf.d/10-consul
   ```

2. Restarting the DNS service:
   ```bash
   sudo systemctl restart dnsmasq
   ```

This allows all devices on your network to resolve `.consul` domains through your Synology NAS.

## Service Registration

Other services in the platform register themselves with Consul, enabling:

1. **Service Discovery**: Services can find each other by name
2. **Health Checking**: Consul monitors service health
3. **DNS Resolution**: Services are accessible via DNS (service.service.consul)
4. **Metadata Exchange**: Services can advertise capabilities through tags
5. **Homepage Integration**: Services provide display metadata for the dashboard

For example, this is how Traefik discovers services to route:

```hcl
[providers.consulCatalog]
  prefix = "traefik"
  exposedByDefault = false
  
  [providers.consulCatalog.endpoint]
    address = "127.0.0.1:8500"
    scheme = "http"
```

## Homepage Dashboard Integration

For the Homepage dashboard, services register with additional metadata:

```hcl
service {
  name = "grafana"
  port = "http"
  
  tags = [
    "traefik.enable=true",
    "traefik.http.routers.grafana.rule=Host(`grafana.homelab.local`)",
    "homepage.name=Grafana",
    "homepage.icon=grafana.png",
    "homepage.group=Monitoring",
    "homepage.description=Metrics and dashboard visualization"
  ]
}
```

These tags allow Homepage to automatically discover and categorize services for display.

## Accessing Consul

You can access Consul through multiple interfaces:

1. **Web UI**: `http://consul.homelab.local` or `http://your-synology-ip:8500`
2. **HTTP API**: `http://your-synology-ip:8500/v1/...`
3. **DNS Interface**: `dig @127.0.0.1 -p 8600 <service>.service.consul`
4. **Command Line**: Using the Consul CLI (if installed)

## Memory Optimization for Synology

Since the DS923+ has 32GB RAM, you can optimize Consul's memory usage:

```hcl
resources {
  cpu    = 500  # 0.5 cores
  memory = 1024 # 1 GB RAM
}
```

This provides ample memory for Consul while leaving resources for other services.

## Security Considerations

The default setup is optimized for ease of use in a homelab environment. For enhanced security:

1. **Integration with Vault**: Configure Consul to use Vault for secret storage
2. **Enable ACLs**: Configure access control lists
3. **Enable TLS**: Secure communications with certificates
4. **Set Agent Tokens**: Use tokens for agent communications

To implement these enhancements, add the appropriate configuration to your `custom.conf` file.

## Scaling Considerations

While the default setup uses a single Consul server, you can scale to a multi-server cluster if needed in the future:

1. Modify the `count` parameter in the job definition
2. Set appropriate bootstrap settings
3. Configure retry_join for server discovery

For most Synology homelab setups, a single server is sufficient.

## Key Consul Commands

Useful Consul commands for administration:

- **List services**: `curl http://localhost:8500/v1/catalog/services`
- **View nodes**: `curl http://localhost:8500/v1/catalog/nodes`
- **Check service health**: `curl http://localhost:8500/v1/health/service/<service-name>`
- **List KV pairs**: `curl http://localhost:8500/v1/kv/?recurse`
- **Store KV pair**: `curl -X PUT -d '<value>' http://localhost:8500/v1/kv/<key>`

## Monitoring Consul

Consul's status can be monitored through:

1. **Prometheus**: Configured to scrape Consul metrics
2. **Grafana**: Dashboards available for visualizing metrics
3. **Consul UI**: Real-time status of services and nodes
4. **Nomad UI**: Status of the Consul job and allocation
5. **Homepage Dashboard**: High-level status display

## Handling DSM Updates

When updating your Synology DSM:

1. Consul will typically restart automatically
2. Data will persist in the mapped volume
3. After an update, verify DNS integration still works:
   ```bash
   # If DNS resolution stops working, restore the configuration
   sudo cp /volume1/docker/nomad/config/10-consul /etc/dnsmasq.conf.d/
   sudo systemctl restart dnsmasq
   ```

## Using Consul in Your Applications

You can leverage Consul from your own applications deployed to the platform:

1. **Service Registration**: Register your service with Consul
2. **Service Discovery**: Look up other services by name
3. **Key-Value Storage**: Store and retrieve configuration
4. **Health Checking**: Register health checks for your service
5. **Homepage Integration**: Add metadata for dashboard display

## Troubleshooting

Common issues and their solutions:

1. **Consul Not Starting**:
   - Check logs: `nomad alloc logs <alloc-id>`
   - Verify data directory permissions
   - Ensure ports are available

2. **Services Not Registering**:
   - Check if services have Consul service blocks
   - Verify network connectivity between services and Consul
   - Inspect service tags and configuration

3. **DNS Resolution Failures**:
   - Test direct DNS query: `dig @127.0.0.1 -p 8600 consul.service.consul`
   - Check if the service is registered
   - Verify Consul DNS service is running
   - Check if dnsmasq configuration is correct

4. **UI Not Accessible**:
   - Verify Consul is running with `nomad job status consul`
   - Check if Traefik is routing correctly
   - Try direct access via IP:PORT

## Next Steps

After deploying Consul, the next step is to set up Traefik for reverse proxy functionality. This is covered in [Traefik Setup](04-traefik-setup.md).