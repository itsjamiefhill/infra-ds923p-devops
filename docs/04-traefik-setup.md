# Traefik Setup for Synology DS923+

This document provides detailed information about the Traefik reverse proxy component of the HomeLab DevOps Platform deployed on Synology DS923+.

## Overview

Traefik is a modern HTTP reverse proxy and load balancer that integrates with existing infrastructure components. In the HomeLab DevOps Platform, Traefik handles:

- Routing requests to the appropriate service based on domain name
- Providing a unified entry point for all web services
- Automatically discovering services through Consul integration
- TLS termination with self-signed or Let's Encrypt wildcard certificates
- OIDC authentication integration for services
- Dashboard for monitoring and management

## Architecture

The platform implements Traefik as a central gateway:

- **Deployment Mode**: Single instance on Synology NAS
- **Service Discovery**: Consul Catalog integration
- **Dynamic Configuration**: File and Consul-based configuration
- **Entrypoints**: HTTP, HTTPS, and admin interface
- **Dashboard**: Web interface for monitoring routes and services
- **Certificate Management**: Self-signed certificates or bring your own
- **OIDC Integration**: Authentication middleware for services
- **Nomad SSL Integration**: Secure communication with Nomad API

## Prerequisites

Before deploying Traefik, ensure the following requirements are met:

1. **Docker Access for Nomad**: The Nomad user must have access to the Docker socket. This is critical for deployment success and requires:
   ```bash
   sudo synogroup --add docker                     # create a docker group
   sudo synogroup --member docker nomad            # add nomad user to docker group
   sudo chown root:docker /var/run/docker.sock     # change socket ownership
   ```

2. **Nomad Authentication**: A management token for Nomad should be available, especially if ACLs are enabled
   
3. **Open Ports**: Ports 80, 443, and 8081 (or your custom ports) must be available on the system

4. **SSL Configuration**: If using Nomad with SSL, ensure the certificate files are available at the standard paths:
   ```bash
   # Nomad CA certificate
   /var/packages/nomad/shares/nomad/etc/certs/nomad-ca.pem
   # Nomad client certificate
   /var/packages/nomad/shares/nomad/etc/certs/nomad-cert.pem
   # Nomad client key
   /var/packages/nomad/shares/nomad/etc/certs/nomad-key.pem
   ```

## Nomad SSL Integration

The Traefik deployment script now automatically detects and uses Nomad's SSL configuration if available:

1. **Automatic Detection**: The script checks for the existence of Nomad's SSL certificates at their standard paths
2. **Environment Setup**: If certificates are found, the appropriate environment variables are set:
   ```bash
   export NOMAD_ADDR="https://127.0.0.1:4646"
   export NOMAD_CACERT="/var/packages/nomad/shares/nomad/etc/certs/nomad-ca.pem"
   export NOMAD_CLIENT_CERT="/var/packages/nomad/shares/nomad/etc/certs/nomad-cert.pem"
   export NOMAD_CLIENT_KEY="/var/packages/nomad/shares/nomad/etc/certs/nomad-key.pem"
   ```
3. **Secure API Calls**: All interactions with the Nomad API use these certificates for validation
4. **Helper Script**: A centralized `nomad-ssl-env.sh` helper script is provided to ensure consistent SSL configuration across all management tasks

### Using the Nomad SSL Helper Script

The deployment creates a helper script at `bin/nomad-ssl-env.sh` that you can source in any script that needs to interact with Nomad:

```bash
# Add this to any script that interacts with Nomad
source /path/to/bin/nomad-ssl-env.sh

# Now you can run Nomad commands with proper SSL configuration
nomad job status
```

To check your SSL configuration:

```bash
source /path/to/bin/nomad-ssl-env.sh --verbose
```

## Volume Configuration with Mount Directives

The Traefik job now uses Nomad's `mount` directive instead of Docker's `volumes` configuration. This approach provides better compatibility with Synology's Nomad implementation and follows best practices:

```hcl
config {
  image = "traefik:v2.9"
  ports = ["http", "https", "admin"]
  
  # Using mount directive instead of volumes
  mount {
    type = "bind"
    source = "local/traefik.toml"
    target = "/etc/traefik/traefik.toml"
    readonly = true
  }
  
  mount {
    type = "bind"
    source = "local/dynamic"
    target = "/etc/traefik/dynamic"
    readonly = false
  }
  
  mount {
    type = "bind"
    source = "${DATA_DIR}/certificates"
    target = "/etc/traefik/certs"
    readonly = true
  }
}
```

The advantages of the mount directive include:
- Clearer semantics (explicit type, source, target, and readonly properties)
- Better compatibility with Synology's Nomad implementation
- Consistent with Nomad best practices
- Improved security through explicit readonly flags

## Configuration

Traefik configuration is defined in `jobs/traefik.hcl`, which is generated by the `04-deploy-traefik.sh` script. Key configuration elements include:

| Parameter | Default Value | Description |
|-----------|---------------|-------------|
| HTTP Port | 80 | Standard HTTP port (redirects to HTTPS) |
| HTTPS Port | 443 | Standard HTTPS port (for TLS) |
| Admin Port | 8081 | Dashboard and API |
| Providers | Consul Catalog, File | Configuration sources |
| Log Level | DEBUG | Logging verbosity (raised from INFO for better troubleshooting) |
| Dashboard | Enabled | Web interface |
| Certificates | Self-signed | Created if none provided |
| OIDC | Optional | Authentication middleware |
| Health Check | TCP-based | More reliable than HTTP checks |

## Certificate Configuration

The platform supports two approaches for TLS certificates:

### 1. Bring Your Own Certificates

If you have existing certificates, specify their paths in your configuration:

```bash
# In custom.conf
WILDCARD_CERT_PATH="/path/to/your/cert.pem"
WILDCARD_KEY_PATH="/path/to/your/key.pem"
```

### 2. Auto-generated Self-signed Certificates

If no certificates are provided, the script automatically generates self-signed certificates for your domain:

```bash
# Example of auto-generated certificate for *.homelab.local
openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \
  -keyout "${CONFIG_DIR}/certs/wildcard.key" \
  -out "${CONFIG_DIR}/certs/wildcard.crt" \
  -subj "/CN=*.${domain}" \
  -addext "subjectAltName=DNS:*.${domain},DNS:${domain}"
```

## OIDC Authentication Integration

Traefik can be configured with middleware to handle OIDC authentication:

```toml
[http.middlewares.oidc-auth.forwardAuth]
  address = "http://auth.service.consul:4181"
  trustForwardHeader = true
  authResponseHeaders = ["X-Forwarded-User", "X-Forwarded-Groups"]
```

This middleware can be applied to services that require authentication but don't support OIDC natively.

## Technical Implementation

The Traefik deployment is implemented as a Nomad job with a Docker driver. Here's the updated job definition structure with mount directives and improved health checks:

```hcl
job "traefik" {
  datacenters = ["dc1"]
  type = "service"

  group "traefik" {
    count = 1

    network {
      port "http" {
        static = 80
      }
      port "https" {
        static = 443
      }
      port "admin" {
        static = 8081
      }
    }

    task "traefik" {
      driver = "docker"

      config {
        image = "traefik:v2.9"
        ports = ["http", "https", "admin"]
        
        # Using mount directive instead of volumes
        mount {
          type = "bind"
          source = "local/traefik.toml"
          target = "/etc/traefik/traefik.toml"
          readonly = true
        }
        
        mount {
          type = "bind"
          source = "local/dynamic"
          target = "/etc/traefik/dynamic"
          readonly = false
        }
        
        mount {
          type = "bind"
          source = "${DATA_DIR}/certificates"
          target = "/etc/traefik/certs"
          readonly = true
        }
      }

      template {
        data = <<EOH
[entryPoints]
  [entryPoints.web]
    address = ":80"
    [entryPoints.web.http.redirections.entryPoint]
      to = "websecure"
      scheme = "https"
  
  [entryPoints.websecure]
    address = ":443"
  
  [entryPoints.traefik]
    address = ":8081"

[api]
  dashboard = true
  insecure = true

[providers.consulCatalog]
  prefix = "traefik"
  exposedByDefault = false
  
  [providers.consulCatalog.endpoint]
    address = "{{ env "NOMAD_IP_http" }}:8500"
    scheme = "http"

[providers.file]
  directory = "/etc/traefik/dynamic"
  watch = true

[log]
  level = "DEBUG"

[accessLog]

[tls]
  [[tls.certificates]]
    certFile = "/etc/traefik/certs/wildcard.crt"
    keyFile = "/etc/traefik/certs/wildcard.key"
EOH
        destination = "local/traefik.toml"
      }

      resources {
        cpu    = 500
        memory = 512
      }

      service {
        name = "traefik"
        port = "http"
        
        tags = [
          "traefik.enable=true",
          "traefik.http.routers.traefik.rule=Host(`traefik.homelab.local`)",
          "traefik.http.routers.traefik.service=api@internal",
          "traefik.http.routers.traefik.tls=true",
          "homepage.name=Traefik",
          "homepage.icon=traefik.png",
          "homepage.group=Infrastructure",
          "homepage.description=Reverse Proxy and Load Balancer"
        ]
        
        check {
          type     = "tcp"   # TCP check instead of HTTP for better reliability
          port     = "admin"
          interval = "30s"  # Longer interval
          timeout  = "5s"   # Longer timeout
          
          # Add a check restart policy to avoid failing the deployment
          check_restart {
            limit = 3
            grace = "120s"
            ignore_warnings = true
          }
        }
      }
    }
  }
}
```

## Nomad Authentication

Traefik deployment requires proper Nomad authentication, which is handled by the deployment script. The script will:

1. Check for existing authentication in `config/nomad_auth.conf`
2. Prompt for a management token if not found
3. Securely store the token for future operations
4. Use the token for all Nomad API interactions

```bash
# Example token configuration
echo "NOMAD_TOKEN=your-token-here" > config/nomad_auth.conf
chmod 600 config/nomad_auth.conf
```

## Docker Permissions for Nomad

For Traefik to deploy successfully via Nomad, the Nomad user must have access to the Docker socket. This is a critical requirement that caused many of our initial deployment issues.

```bash
# Create docker group if it doesn't exist
sudo synogroup --add docker

# Add nomad user to docker group
sudo synogroup --member docker nomad

# Fix socket permissions
sudo chown root:docker /var/run/docker.sock

# Restart Nomad to apply the changes
sudo systemctl restart nomad   # Use appropriate restart method for your system
```

Without these permissions, you'll encounter the "missing drivers" error in Nomad.

## Health Check Configuration

We've improved the health check configuration for more reliable deployments:

1. **TCP instead of HTTP**: TCP checks are more reliable for initial service availability
2. **Longer grace period**: 120s grace period gives Traefik time to initialize fully
3. **Increased retry limit**: 3 retries helps overcome temporary issues
4. **Warning ignoring**: ignore_warnings prevents non-critical issues from failing the deployment

```hcl
check {
  type     = "tcp"
  port     = "admin"
  interval = "30s"
  timeout  = "5s"
  
  check_restart {
    limit = 3
    grace = "120s"
    ignore_warnings = true
  }
}
```

## Helper Scripts

The deployment creates several useful helper scripts in the `bin/` directory:

- **start-traefik.sh**: Starts Traefik with proper authentication and SSL configuration
- **stop-traefik.sh**: Stops the Traefik job
- **traefik-status.sh**: Checks current Traefik status and connectivity
- **traefik-troubleshoot.sh**: Comprehensive diagnostics for troubleshooting
- **nomad-ssl-env.sh**: Sets up the Nomad SSL environment variables

```bash
# Run the troubleshooting script
./bin/traefik-troubleshoot.sh
```

## Accessing Traefik

You can access Traefik through multiple interfaces:

1. **Dashboard**: `https://traefik.homelab.local` or `http://your-synology-ip:8081`
2. **HTTP API**: `https://traefik.homelab.local/api` or `http://your-synology-ip:8081/api`
3. **Ping Endpoint**: `https://traefik.homelab.local/ping` or `http://your-synology-ip:8081/ping`

## Local DNS Configuration

For the Synology local environment, configure your DNS server to resolve all service domains, or add entries to your local hosts file:

```
# Example /etc/hosts entries (on client machines)
10.0.4.X  traefik.homelab.local consul.homelab.local vault.homelab.local
10.0.4.X  grafana.homelab.local prometheus.homelab.local loki.homelab.local
10.0.4.X  registry.homelab.local home.homelab.local
```

Replace 10.0.4.X with your Synology's IP address.

## Service Integration

Traefik automatically discovers and routes traffic to services that:

1. Are registered in Consul
2. Have the `traefik.enable=true` tag
3. Define routing rules through tags

The platform's services are pre-configured with appropriate Traefik tags for automatic routing.

## URL Scheme

The platform's services follow this URL naming convention with the homelab.local domain:

| Service | URL |
|---------|-----|
| Consul | consul.homelab.local |
| Traefik | traefik.homelab.local |
| Grafana | grafana.homelab.local |
| Prometheus | prometheus.homelab.local |
| Loki | loki.homelab.local |
| Docker Registry | registry.homelab.local |
| Vault | vault.homelab.local |
| Homepage | home.homelab.local |

These hostnames can be customized in your `custom.conf` file.

## Troubleshooting

### Common issues and their solutions:

#### 1. Nomad "missing drivers" error
- **Cause**: Nomad user doesn't have access to Docker
- **Solution**: 
  ```bash
  sudo synogroup --add docker                     # create a docker group
  sudo synogroup --member docker nomad            # add nomad user to docker group
  sudo chown root:docker /var/run/docker.sock     # change socket ownership
  sudo systemctl restart nomad                    # restart Nomad service
  ```

#### 2. Permission Denied (403) errors
- **Cause**: Missing or invalid Nomad authentication token
- **Solution**: Provide a valid management token during deployment or in `config/nomad_auth.conf`

#### 3. Health check failures
- **Cause**: Default HTTP checks too strict, timeout too short
- **Solution**: Use TCP checks with longer grace periods as shown in the updated configuration

#### 4. Routing Not Working
- **Check**: Service has correct Traefik tags
- **Verify**: Host rule matches expected domain
- **Ensure**: Service is registered in Consul

#### 5. Dashboard Not Accessible
- **Check**: Traefik is running with `nomad job status traefik`
- **Verify**: Admin port is accessible with `curl -v http://localhost:8081/ping`
- **Ensure**: Hostname resolution is working

#### 6. Certificate Issues
- **Check**: Certificate validity with `openssl x509 -in wildcard.crt -text -noout`
- **Verify**: Certificate is correctly mounted in container
- **Ensure**: Certificate covers the domains you're using

#### 7. Service Discovery Problems
- **Verify**: Consul is running
- **Check**: Service is registered in Consul
- **Ensure**: Consul provider is correctly configured

#### 8. SSL Certificate Issues with Nomad
- **Check**: Certificate existence with `ls -la $NOMAD_CACERT $NOMAD_CLIENT_CERT $NOMAD_CLIENT_KEY`
- **Verify**: Certificate permissions with `chmod 644 $NOMAD_CACERT $NOMAD_CLIENT_CERT && chmod 600 $NOMAD_CLIENT_KEY`
- **Test**: Connection with `curl --cacert $NOMAD_CACERT --cert $NOMAD_CLIENT_CERT --key $NOMAD_CLIENT_KEY https://127.0.0.1:4646/v1/agent/self`

### Diagnostic Commands

```bash
# Check Docker permissions
ls -la /var/run/docker.sock
id nomad
getent group docker

# Check Nomad connectivity
source ./bin/nomad-ssl-env.sh
curl -s -H "X-Nomad-Token: ${NOMAD_TOKEN}" \
     --cacert ${NOMAD_CACERT} \
     --cert ${NOMAD_CLIENT_CERT} \
     --key ${NOMAD_CLIENT_KEY} \
     ${NOMAD_ADDR}/v1/jobs

# Check Traefik allocation logs
source ./bin/nomad-ssl-env.sh
ALLOC_ID=$(nomad job allocs -latest traefik | grep -v ID | head -1 | awk '{print $1}')
nomad alloc logs ${ALLOC_ID} traefik

# Test Traefik endpoints
curl -v http://localhost:8081/ping
curl https://traefik.homelab.local
```

### Advanced Troubleshooting

For more complex issues, the `traefik-troubleshoot.sh` script performs a comprehensive diagnostic check:

```bash
./bin/traefik-troubleshoot.sh
```

This script:
1. Checks Nomad SSL configuration and connectivity
2. Verifies that certificate files exist and are readable
3. Examines job status and allocations
4. Reviews container logs for errors
5. Tests network connectivity
6. Provides detailed output for diagnosing issues

## Fallback Docker Deployment

If Nomad deployment fails, particularly due to Docker driver issues, the script can create a direct Docker deployment as a fallback:

```bash
./bin/traefik-docker-run.sh
```

This script:
1. Creates necessary configuration files
2. Deploys Traefik directly via Docker
3. Mounts the same certificate files and configuration
4. Provides the same functionality, but outside of Nomad's control

## Next Steps

After deploying Traefik, the next step is to set up HashiCorp Vault for secrets management. This is covered in [Vault Setup](05-vault-setup.md).