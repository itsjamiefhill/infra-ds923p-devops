# Traefik Setup for Synology DS923+

This document provides detailed information about the Traefik reverse proxy component of the HomeLab DevOps Platform deployed on Synology DS923+.

## Overview

Traefik is a modern HTTP reverse proxy and load balancer that integrates with existing infrastructure components. In the HomeLab DevOps Platform, Traefik handles:

- Routing requests to the appropriate service based on domain name
- Providing a unified entry point for all web services
- Automatically discovering services through Consul integration
- TLS termination with Let's Encrypt wildcard certificates
- OIDC authentication integration for services
- Dashboard for monitoring and management

## Architecture

The platform implements Traefik as a central gateway:

- **Deployment Mode**: Single instance on Synology NAS
- **Service Discovery**: Consul Catalog integration
- **Dynamic Configuration**: File and Consul-based configuration
- **Entrypoints**: HTTP, HTTPS, and admin interface
- **Dashboard**: Web interface for monitoring routes and services
- **Certificate Management**: Using Let's Encrypt wildcard certificates for *.jamfhi.com
- **OIDC Integration**: Authentication middleware for services

## Prerequisites

Before deploying Traefik, ensure the following requirements are met:

1. **Docker Access for Nomad**: The Nomad user must have access to the Docker socket. This is critical for deployment success and requires:
   ```bash
   sudo synogroup --add docker                     # create a docker group
   sudo synogroup --member docker nomad            # add nomad user to docker group
   sudo chown root:docker /var/run/docker.sock     # change socket ownership
   ```

2. **Nomad Authentication**: A management token for Nomad should be available, especially if ACLs are enabled
   
3. **Open Ports**: Ports 80, 443, and 8081 (or your custom ports) must be available on the system

4. **Let's Encrypt Certificates**: Your Let's Encrypt wildcard certificates for *.jamfhi.com must be accessible to the deployment script

## Configuration

Traefik configuration is defined in `jobs/traefik.hcl`, which is generated by the `04-deploy-traefik.sh` script. Key configuration elements include:

| Parameter | Default Value | Description |
|-----------|---------------|-------------|
| HTTP Port | 80 | Standard HTTP port (redirects to HTTPS) |
| HTTPS Port | 443 | Standard HTTPS port (for TLS) |
| Admin Port | 8081 | Dashboard and API |
| Providers | Consul Catalog, File | Configuration sources |
| Log Level | DEBUG | Logging verbosity (raised from INFO for better troubleshooting) |
| Dashboard | Enabled | Web interface |
| Certificates | Let's Encrypt | Wildcard certificates for *.jamfhi.com |
| OIDC | Optional | Authentication middleware |
| Health Check | TCP-based | More reliable than HTTP checks |

## Let's Encrypt Certificate Configuration

For the Synology homelab environment, the platform uses Let's Encrypt wildcard certificates for *.jamfhi.com:

```toml
[tls]
  [[tls.certificates]]
    certFile = "/etc/traefik/certs/wildcard.crt"
    keyFile = "/etc/traefik/certs/wildcard.key"
```

The certificates are mounted into the Traefik container during deployment. This enables HTTPS for all services with valid, trusted certificates.

## OIDC Authentication Integration

Traefik can be configured with middleware to handle OIDC authentication:

```toml
[http.middlewares.oidc-auth.forwardAuth]
  address = "http://auth.service.consul:4181"
  trustForwardHeader = true
  authResponseHeaders = ["X-Forwarded-User", "X-Forwarded-Groups"]
```

This middleware can be applied to services that require authentication but don't support OIDC natively.

## Routing Configuration

Traefik uses a combination of configuration approaches:

1. **Static Configuration**: Defined in traefik.toml, including:
   - Entrypoints
   - Provider settings
   - TLS settings
   - Dashboard and API configuration

2. **Dynamic Configuration**: Derived from:
   - Service tags in Consul
   - Files in the dynamic configuration directory

For example, services register themselves with Traefik using Consul tags:

```hcl
service {
  name = "grafana"
  port = "http"
  
  tags = [
    "traefik.enable=true",
    "traefik.http.routers.grafana.rule=Host(`grafana.jamfhi.com`)",
    "traefik.http.routers.grafana.tls=true"
  ]
}
```

## Technical Implementation

The Traefik deployment is implemented as a Nomad job with a Docker driver. Here's the updated job definition structure with improved health checks:

```hcl
job "traefik" {
  datacenters = ["dc1"]
  type = "service"

  group "traefik" {
    count = 1

    network {
      port "http" {
        static = 80
      }
      port "https" {
        static = 443
      }
      port "admin" {
        static = 8081
      }
    }

    task "traefik" {
      driver = "docker"

      config {
        image = "traefik:v2.9"
        ports = ["http", "https", "admin"]
        
        volumes = [
          "local/traefik.toml:/etc/traefik/traefik.toml",
          "local/dynamic:/etc/traefik/dynamic",
          "${DATA_DIR}/certificates:/etc/traefik/certs:ro"
        ]
      }

      template {
        data = <<EOH
[entryPoints]
  [entryPoints.web]
    address = ":80"
    [entryPoints.web.http.redirections.entryPoint]
      to = "websecure"
      scheme = "https"
  
  [entryPoints.websecure]
    address = ":443"
  
  [entryPoints.traefik]
    address = ":8081"

[api]
  dashboard = true
  insecure = true

[providers.consulCatalog]
  prefix = "traefik"
  exposedByDefault = false
  
  [providers.consulCatalog.endpoint]
    address = "{{ env "NOMAD_IP_http" }}:8500"
    scheme = "http"

[providers.file]
  directory = "/etc/traefik/dynamic"
  watch = true

[log]
  level = "DEBUG"

[accessLog]

[tls]
  [[tls.certificates]]
    certFile = "/etc/traefik/certs/wildcard.crt"
    keyFile = "/etc/traefik/certs/wildcard.key"
EOH
        destination = "local/traefik.toml"
      }

      resources {
        cpu    = 500
        memory = 512
      }

      service {
        name = "traefik"
        port = "http"
        
        tags = [
          "traefik.enable=true",
          "traefik.http.routers.traefik.rule=Host(`traefik.jamfhi.com`)",
          "traefik.http.routers.traefik.service=api@internal",
          "traefik.http.routers.traefik.tls=true",
          "homepage.name=Traefik",
          "homepage.icon=traefik.png",
          "homepage.group=Infrastructure",
          "homepage.description=Reverse Proxy and Load Balancer"
        ]
        
        check {
          type     = "tcp"   # TCP check instead of HTTP for better reliability
          port     = "admin"
          interval = "30s"  # Longer interval
          timeout  = "5s"   # Longer timeout
          
          # Add a check restart policy to avoid failing the deployment
          check_restart {
            limit = 3
            grace = "120s"
            ignore_warnings = true
          }
        }
      }
    }
  }
}
```

## Certificate Integration for Synology Environment

Let's Encrypt wildcard certificates are integrated during the installation process:

```bash
# Copy existing Let's Encrypt certificates to the right locations
mkdir -p $DATA_DIR/certificates
cp /path/to/letsencrypt/fullchain.pem $DATA_DIR/certificates/wildcard.crt
cp /path/to/letsencrypt/privkey.pem $DATA_DIR/certificates/wildcard.key

# Set proper permissions for Nomad access
sudo chown -R nomad:users $DATA_DIR/certificates
sudo chmod 644 $DATA_DIR/certificates/wildcard.crt
sudo chmod 600 $DATA_DIR/certificates/wildcard.key
```

## Deployment Script Architecture

The Traefik deployment scripts are organized in a modular fashion for improved maintainability:

1. **04-deploy-traefik.sh** - Main coordinator script
2. **04a-traefik-utils-core.sh** - Core utilities, logging, auth handling
3. **04b-traefik-utils-cert.sh** - Certificate management
4. **04c-traefik-utils-config.sh** - Configuration generation
5. **04d-traefik-utils-deploy.sh** - Deployment functions
6. **04e-traefik-utils-helpers.sh** - Helper scripts generation

This modular approach makes maintenance and troubleshooting much easier.

## Nomad Authentication

Traefik deployment requires proper Nomad authentication, which is handled by the deployment script. The script will:

1. Check for existing authentication in `config/nomad_auth.conf`
2. Prompt for a management token if not found
3. Securely store the token for future operations
4. Use the token for all Nomad API interactions

```bash
# Example token configuration
echo "NOMAD_TOKEN=your-token-here" > config/nomad_auth.conf
chmod 600 config/nomad_auth.conf
```

## Docker Permissions for Nomad

For Traefik to deploy successfully via Nomad, the Nomad user must have access to the Docker socket. This is a critical requirement that caused many of our initial deployment issues.

```bash
# Create docker group if it doesn't exist
sudo synogroup --add docker

# Add nomad user to docker group
sudo synogroup --member docker nomad

# Fix socket permissions
sudo chown root:docker /var/run/docker.sock

# Restart Nomad to apply the changes
sudo systemctl restart nomad   # Use appropriate restart method for your system
```

Without these permissions, you'll encounter the "missing drivers" error in Nomad.

## Health Check Configuration

We've improved the health check configuration for more reliable deployments:

1. **TCP instead of HTTP**: TCP checks are more reliable for initial service availability
2. **Longer grace period**: 120s grace period gives Traefik time to initialize fully
3. **Increased retry limit**: 3 retries helps overcome temporary issues
4. **Warning ignoring**: ignore_warnings prevents non-critical issues from failing the deployment

```hcl
check {
  type     = "tcp"
  port     = "admin"
  interval = "30s"
  timeout  = "5s"
  
  check_restart {
    limit = 3
    grace = "120s"
    ignore_warnings = true
  }
}
```

## Accessing Traefik

You can access Traefik through multiple interfaces:

1. **Dashboard**: `https://traefik.jamfhi.com` or `http://your-synology-ip:8081`
2. **HTTP API**: `https://traefik.jamfhi.com/api` or `http://your-synology-ip:8081/api`
3. **Ping Endpoint**: `https://traefik.jamfhi.com/ping` or `http://your-synology-ip:8081/ping`

## Local DNS Configuration

For the Synology local environment, configure your DNS server to resolve all service domains, or add entries to your local hosts file:

```
# Example /etc/hosts entries (on client machines)
10.0.4.X  traefik.jamfhi.com consul.jamfhi.com vault.jamfhi.com
10.0.4.X  grafana.jamfhi.com prometheus.jamfhi.com loki.jamfhi.com
10.0.4.X  registry.jamfhi.com home.jamfhi.com
```

Replace 10.0.4.X with your Synology's IP address.

## Service Integration

Traefik automatically discovers and routes traffic to services that:

1. Are registered in Consul
2. Have the `traefik.enable=true` tag
3. Define routing rules through tags

The platform's services are pre-configured with appropriate Traefik tags for automatic routing.

## URL Scheme

The platform's services follow this URL naming convention with the jamfhi.com domain:

| Service | URL |
|---------|-----|
| Consul | consul.jamfhi.com |
| Traefik | traefik.jamfhi.com |
| Grafana | grafana.jamfhi.com |
| Prometheus | prometheus.jamfhi.com |
| Loki | loki.jamfhi.com |
| Docker Registry | registry.jamfhi.com |
| Vault | vault.jamfhi.com |
| Homepage | home.jamfhi.com |

These hostnames can be customized in your `custom.conf` file.

## Memory Optimization for Synology DS923+

With 32GB RAM available on your system, Traefik is configured with moderate resource allocation:

```hcl
resources {
  cpu    = 500  # 0.5 cores
  memory = 512  # 512 MB RAM
}
```

This is sufficient for typical homelab usage while leaving ample resources for other services.

## Benefits of Let's Encrypt Certificates

Using Let's Encrypt wildcard certificates for *.jamfhi.com provides several advantages:

1. **Browser Trust**: Certificates are trusted by all major browsers without additional configuration
2. **Mobile Support**: Works seamlessly on mobile devices without installing custom certificates
3. **Professional Appearance**: Avoids security warnings when accessing services
4. **Simplicity**: One certificate covers all subdomains under jamfhi.com
5. **Renewability**: Can be renewed automatically (typically every 90 days)

## Advanced Features

Traefik supports many advanced features that you can enable:

1. **Middleware**: Add authentication, headers, rate limiting
2. **Path-based Routing**: Route based on URL path
3. **Load Balancing**: Distribute traffic across multiple instances
4. **Circuit Breaking**: Prevent cascading failures
5. **Canary Deployments**: Route percentage of traffic

To implement these features, add the appropriate Traefik tags to your service definitions.

## Monitoring

Traefik exports Prometheus metrics that are automatically collected by the platform's monitoring stack. You can view these metrics in Grafana dashboards.

Key metrics include:
- Request counts and latencies
- Response status codes
- Router and service states
- TLS certificate information

## Logs

Traefik logs are:

1. Collected by Promtail
2. Stored in Loki
3. Viewable in Grafana dashboards

You can also view logs directly using:

```bash
nomad alloc logs <traefik-alloc-id>
```

## Handling DSM Updates

When updating your Synology DSM:

1. Traefik will typically restart automatically
2. Certificate data will persist in the mapped volume
3. After an update, verify services are accessible:
   ```bash
   curl https://traefik.jamfhi.com
   ```

## Troubleshooting

### Common issues and their solutions:

#### 1. Nomad "missing drivers" error
- **Cause**: Nomad user doesn't have access to Docker
- **Solution**: 
  ```bash
  sudo synogroup --add docker                     # create a docker group
  sudo synogroup --member docker nomad            # add nomad user to docker group
  sudo chown root:docker /var/run/docker.sock     # change socket ownership
  sudo systemctl restart nomad                    # restart Nomad service
  ```

#### 2. Permission Denied (403) errors
- **Cause**: Missing or invalid Nomad authentication token
- **Solution**: Provide a valid management token during deployment or in `config/nomad_auth.conf`

#### 3. Health check failures
- **Cause**: Default HTTP checks too strict, timeout too short
- **Solution**: Use TCP checks with longer grace periods as shown in the updated configuration

#### 4. Routing Not Working
- **Check**: Service has correct Traefik tags
- **Verify**: Host rule matches expected domain
- **Ensure**: Service is registered in Consul

#### 5. Dashboard Not Accessible
- **Check**: Traefik is running with `nomad job status traefik`
- **Verify**: Admin port is accessible with `curl -v http://localhost:8081/ping`
- **Ensure**: Hostname resolution is working

#### 6. Certificate Issues
- **Check**: Certificate validity with `openssl x509 -in wildcard.crt -text -noout`
- **Verify**: Certificate is correctly mounted in container
- **Ensure**: Certificate covers the domains you're using

#### 7. Service Discovery Problems
- **Verify**: Consul is running
- **Check**: Service is registered in Consul
- **Ensure**: Consul provider is correctly configured

### Diagnostic Commands

```bash
# Check Docker permissions
ls -la /var/run/docker.sock
id nomad
getent group docker

# Check Nomad connectivity
curl -s -H "X-Nomad-Token: ${NOMAD_TOKEN}" ${NOMAD_ADDR}/v1/jobs

# Check Traefik allocation logs
ALLOC_ID=$(nomad job allocs -latest traefik | grep -v ID | head -1 | awk '{print $1}')
nomad alloc logs ${ALLOC_ID} traefik

# Test Traefik endpoints
curl -v http://localhost:8081/ping
curl https://traefik.jamfhi.com
```

### Helper Scripts

The deployment creates several useful helper scripts in the `bin/` directory:

- **start-traefik.sh**: Starts Traefik with proper authentication
- **stop-traefik.sh**: Stops the Traefik job
- **traefik-status.sh**: Checks current Traefik status and connectivity
- **traefik-troubleshoot.sh**: Comprehensive diagnostics for troubleshooting

```bash
# Run the troubleshooting script
./bin/traefik-troubleshoot.sh
```

## Next Steps

After deploying Traefik, the next step is to set up HashiCorp Vault for secrets management. This is covered in [Vault Setup](05-vault-setup.md).