# Traefik Setup for Synology DS923+

This document provides detailed information about the Traefik reverse proxy component of the HomeLab DevOps Platform deployed on Synology DS923+.

## Overview

Traefik is a modern HTTP reverse proxy and load balancer that integrates with existing infrastructure components. In the HomeLab DevOps Platform, Traefik handles:

- Routing requests to the appropriate service based on domain name
- Providing a unified entry point for all web services
- Automatically discovering services through Consul integration
- TLS termination with self-signed certificates
- OIDC authentication integration for services
- Dashboard for monitoring and management

## Architecture

The platform implements Traefik as a central gateway:

- **Deployment Mode**: Single instance on Synology NAS
- **Service Discovery**: Consul Catalog integration
- **Dynamic Configuration**: File and Consul-based configuration
- **Entrypoints**: HTTP, HTTPS, and admin interface
- **Dashboard**: Web interface for monitoring routes and services
- **Certificate Management**: Using self-signed certificates
- **OIDC Integration**: Authentication middleware for services

## Configuration

Traefik configuration is defined in `jobs/traefik.hcl`, which is generated by the `04-deploy-traefik.sh` script. Key configuration elements include:

| Parameter | Default Value | Description |
|-----------|---------------|-------------|
| HTTP Port | 80 | Standard HTTP port (redirects to HTTPS) |
| HTTPS Port | 443 | Standard HTTPS port (for TLS) |
| Admin Port | 8081 | Dashboard and API |
| Providers | Consul Catalog, File | Configuration sources |
| Log Level | INFO | Logging verbosity |
| Dashboard | Enabled | Web interface |
| Certificates | Self-signed | SSL/TLS certificates |
| OIDC | Optional | Authentication middleware |

## Self-Signed Certificate Configuration

For the Synology homelab environment, the platform uses self-signed certificates:

```toml
[tls]
  [[tls.certificates]]
    certFile = "/etc/traefik/certs/homelab.crt"
    keyFile = "/etc/traefik/certs/homelab.key"
```

The certificates are generated during installation and mounted into the Traefik container. This enables HTTPS for all services in your local environment.

## OIDC Authentication Integration

Traefik can be configured with middleware to handle OIDC authentication:

```toml
[http.middlewares.oidc-auth.forwardAuth]
  address = "http://auth.service.consul:4181"
  trustForwardHeader = true
  authResponseHeaders = ["X-Forwarded-User", "X-Forwarded-Groups"]
```

This middleware can be applied to services that require authentication but don't support OIDC natively.

## Routing Configuration

Traefik uses a combination of configuration approaches:

1. **Static Configuration**: Defined in traefik.toml, including:
   - Entrypoints
   - Provider settings
   - TLS settings
   - Dashboard and API configuration

2. **Dynamic Configuration**: Derived from:
   - Service tags in Consul
   - Files in the dynamic configuration directory

For example, services register themselves with Traefik using Consul tags:

```hcl
service {
  name = "grafana"
  port = "http"
  
  tags = [
    "traefik.enable=true",
    "traefik.http.routers.grafana.rule=Host(`grafana.homelab.local`)",
    "traefik.http.routers.grafana.tls=true"
  ]
}
```

## Technical Implementation

The Traefik deployment is implemented as a Nomad job with a Docker driver. Here's the job definition structure:

```hcl
job "traefik" {
  datacenters = ["dc1"]
  type = "service"

  group "traefik" {
    count = 1

    network {
      port "http" {
        static = 80
      }
      port "https" {
        static = 443
      }
      port "admin" {
        static = 8081
      }
    }

    volume "certificates" {
      type = "host"
      read_only = true
      source = "certificates"
    }

    task "traefik" {
      driver = "docker"

      config {
        image = "traefik:v2.9"
        ports = ["http", "https", "admin"]
        
        volumes = [
          "local/traefik.toml:/etc/traefik/traefik.toml",
          "local/dynamic:/etc/traefik/dynamic"
        ]
      }

      volume_mount {
        volume = "certificates"
        destination = "/etc/traefik/certs"
        read_only = true
      }

      template {
        data = <<EOF
[entryPoints]
  [entryPoints.web]
    address = ":80"
    [entryPoints.web.http.redirections.entryPoint]
      to = "websecure"
      scheme = "https"
  
  [entryPoints.websecure]
    address = ":443"
  
  [entryPoints.traefik]
    address = ":8081"

[api]
  dashboard = true
  insecure = true

[providers.consulCatalog]
  prefix = "traefik"
  exposedByDefault = false
  
  [providers.consulCatalog.endpoint]
    address = "consul.service.consul:8500"
    scheme = "http"

[providers.file]
  directory = "/etc/traefik/dynamic"
  watch = true

[tls]
  [[tls.certificates]]
    certFile = "/etc/traefik/certs/homelab.crt"
    keyFile = "/etc/traefik/certs/homelab.key"
EOF
        destination = "local/traefik.toml"
      }

      resources {
        cpu    = 500
        memory = 512
      }

      service {
        name = "traefik"
        port = "http"
        
        tags = [
          "traefik.enable=true",
          "traefik.http.routers.traefik.rule=Host(`traefik.homelab.local`)",
          "traefik.http.routers.traefik.service=api@internal",
          "traefik.http.routers.traefik.tls=true",
          "homepage.name=Traefik",
          "homepage.icon=traefik.png",
          "homepage.group=Infrastructure",
          "homepage.description=Reverse Proxy and Load Balancer"
        ]
      }
    }
  }
}
```

## Certificate Generation for Synology Environment

Self-signed certificates are generated during the installation process:

```bash
# Create a self-signed wildcard certificate
openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \
  -keyout $CONFIG_DIR/certs/homelab.key \
  -out $CONFIG_DIR/certs/homelab.crt \
  -subj "/CN=*.homelab.local" \
  -addext "subjectAltName=DNS:*.homelab.local,DNS:homelab.local"

# Create a volume for certificates
mkdir -p $DATA_DIR/certificates
cp $CONFIG_DIR/certs/homelab.* $DATA_DIR/certificates/

# Register the volume with Nomad
cat > $CONFIG_DIR/certificates.hcl << EOF
volume "certificates" {
  type = "host"
  config {
    source = "$DATA_DIR/certificates"
  }
}
EOF

nomad volume create $CONFIG_DIR/certificates.hcl
```

## Accessing Traefik

You can access Traefik through multiple interfaces:

1. **Dashboard**: `https://traefik.homelab.local` or `http://your-synology-ip:8081`
2. **HTTP API**: `https://your-synology-ip:8081/api`
3. **Ping Endpoint**: `https://your-synology-ip:8081/ping`

## Local DNS Configuration

For the Synology local environment, configure your hosts file or local DNS to resolve all service domains:

```
# Example /etc/hosts entries (on client machines)
10.0.4.X  traefik.homelab.local consul.homelab.local vault.homelab.local
10.0.4.X  grafana.homelab.local prometheus.homelab.local loki.homelab.local
10.0.4.X  registry.homelab.local home.homelab.local
```

Replace 10.0.4.X with your Synology's IP address.

## Service Integration

Traefik automatically discovers and routes traffic to services that:

1. Are registered in Consul
2. Have the `traefik.enable=true` tag
3. Define routing rules through tags

The platform's services are pre-configured with appropriate Traefik tags for automatic routing.

## URL Scheme

The platform's services follow this URL naming convention:

| Service | URL |
|---------|-----|
| Consul | consul.homelab.local |
| Traefik | traefik.homelab.local |
| Grafana | grafana.homelab.local |
| Prometheus | prometheus.homelab.local |
| Loki | loki.homelab.local |
| Docker Registry | registry.homelab.local |
| Vault | vault.homelab.local |
| Homepage | home.homelab.local |

These hostnames can be customized in your `custom.conf` file.

## Memory Optimization for Synology DS923+

With 32GB RAM available on your system, Traefik is configured with moderate resource allocation:

```hcl
resources {
  cpu    = 500  # 0.5 cores
  memory = 512  # 512 MB RAM
}
```

This is sufficient for typical homelab usage while leaving ample resources for other services.

## Certificate Trust on Client Devices

To trust the self-signed certificates across all your devices:

1. **Export the Root Certificate**: Copy `homelab.crt` to client devices
2. **Import to Trust Store**:
   - **Windows**: Import to "Trusted Root Certification Authorities"
   - **macOS**: Import to Keychain, set to "Always Trust"
   - **Linux**: Add to `/usr/local/share/ca-certificates/` and run `update-ca-certificates`
   - **iOS/Android**: Install profile/certificate via Settings

This allows all your devices to trust services secured by your self-signed certificate.

## Advanced Features

Traefik supports many advanced features that you can enable:

1. **Middleware**: Add authentication, headers, rate limiting
2. **Path-based Routing**: Route based on URL path
3. **Load Balancing**: Distribute traffic across multiple instances
4. **Circuit Breaking**: Prevent cascading failures
5. **Canary Deployments**: Route percentage of traffic

To implement these features, add the appropriate Traefik tags to your service definitions.

## Monitoring

Traefik exports Prometheus metrics that are automatically collected by the platform's monitoring stack. You can view these metrics in Grafana dashboards.

Key metrics include:
- Request counts and latencies
- Response status codes
- Router and service states
- TLS certificate information

## Logs

Traefik logs are:

1. Collected by Promtail
2. Stored in Loki
3. Viewable in Grafana dashboards

You can also view logs directly using:

```bash
nomad alloc logs <traefik-alloc-id>
```

## Handling DSM Updates

When updating your Synology DSM:

1. Traefik will typically restart automatically
2. Certificate data will persist in the mapped volume
3. After an update, verify services are accessible:
   ```bash
   curl -k https://traefik.homelab.local
   ```

## Troubleshooting

Common issues and their solutions:

1. **Routing Not Working**:
   - Check if the service has the correct Traefik tags
   - Verify the Host rule matches your expected domain
   - Ensure the service is registered in Consul

2. **Dashboard Not Accessible**:
   - Verify Traefik is running with `nomad job status traefik`
   - Check if the admin port is accessible
   - Ensure hostname resolution is working

3. **Certificate Issues**:
   - Check certificate validity: `openssl x509 -in homelab.crt -text -noout`
   - Verify certificate is correctly mounted in the container
   - Check browser error messages for specific certificate problems

4. **Service Discovery Problems**:
   - Verify Consul is running
   - Check if the service is registered in Consul
   - Ensure the Consul provider is correctly configured

5. **Certificate Trust Issues**:
   - Import the certificate to your device's trust store
   - Use `-k` flag with curl for testing without verification
   - Check certificate's Subject Alternative Name (SAN) includes all domains

## Next Steps

After deploying Traefik, the next step is to set up HashiCorp Vault for secrets management. This is covered in [Vault Setup](05-vault-setup.md).