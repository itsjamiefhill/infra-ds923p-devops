# Docker Registry Setup for Synology DS923+

This document provides detailed information about the Docker Registry component of the HomeLab DevOps Platform for Synology DS923+.

## Overview

The Docker Registry is a stateless, highly scalable server-side application that stores and distributes Docker images. In the HomeLab DevOps Platform, the Docker Registry serves as a private repository for:

- Storing custom Docker images
- Caching frequently used images
- Supporting continuous integration pipelines
- Enabling deployment of custom applications

## Architecture

The platform implements Docker Registry as a standalone service:

- **Deployment Mode**: Single instance
- **Version**: Registry 2.x (default)
- **Persistence**: Host volume mounting for image storage
- **Access**: HTTP interface with TLS via Traefik
- **Authentication**: Integration with Vault and OIDC
- **Integration**: Works with standard Docker CLI

## Configuration

Docker Registry configuration is defined in `jobs/registry.hcl`, which is generated by the `06-deploy-registry.sh` script. Key configuration elements include:

| Parameter | Default Value | Description |
|-----------|---------------|-------------|
| Port | 5000 | Standard Registry port |
| Hostname | registry.homelab.local | Registry hostname |
| Storage | Filesystem | Storage backend |
| Delete | Enabled | Support for image deletion |
| Volume | registry_data | Host volume for data persistence |

## Configuration File

The Registry uses a YAML configuration file generated during deployment:

```yaml
version: 0.1
log:
  level: info
  formatter: json
  fields:
    service: registry
storage:
  filesystem:
    rootdirectory: /var/lib/registry
  delete:
    enabled: true
http:
  addr: :5000
  headers:
    X-Content-Type-Options: [nosniff]
health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3
```

## Data Persistence

Registry data is persisted on the Synology NAS using a Nomad volume:
- **Volume Name**: registry_data
- **Host Path**: `/volume1/nomad/volumes/registry_data` (default)
- **Container Path**: `/var/lib/registry`

This ensures that Docker images are maintained across restarts, DSM updates, and service redeployments.

## Synology Storage Considerations

For the DS923+ with a RAID10 configuration, it's recommended to place the registry data in the `high_capacity` storage class due to the potential size of Docker images:

```hcl
volume "registry_data" {
  type = "host"
  config {
    source = "/volume1/nomad/volumes/high_capacity/registry_data"
  }
}
```

This optimizes storage for large image collections.

## Technical Implementation

The Docker Registry deployment is implemented as a Nomad job with a Docker driver. Here's the job definition structure:

```hcl
job "docker-registry" {
  datacenters = ["dc1"]
  type = "service"

  group "registry" {
    count = 1

    volume "registry_data" {
      type = "host"
      read_only = false
      source = "registry_data"
    }

    task "registry" {
      driver = "docker"

      volume_mount {
        volume = "registry_data"
        destination = "/var/lib/registry"
        read_only = false
      }

      config {
        image = "registry:2"
        ports = ["registry"]
        volumes = [
          "local/config.yml:/etc/docker/registry/config.yml"
        ]
      }
      
      template {
        data = <<EOF
version: 0.1
log:
  level: info
  formatter: json
  fields:
    service: registry
storage:
  filesystem:
    rootdirectory: /var/lib/registry
  delete:
    enabled: true
http:
  addr: :5000
  headers:
    X-Content-Type-Options: [nosniff]
health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3
EOF
        destination = "local/config.yml"
      }

      resources {
        cpu    = 500
        memory = 512
      }

      service {
        name = "registry"
        port = "registry"
        
        tags = [
          "traefik.enable=true",
          "traefik.http.routers.registry.rule=Host(`registry.homelab.local`)",
          "traefik.http.routers.registry.tls=true",
          "homepage.name=Docker Registry",
          "homepage.icon=registry.png",
          "homepage.group=DevOps",
          "homepage.description=Private Docker image repository"
        ]
        
        check {
          type     = "http"
          path     = "/v2/"
          interval = "10s"
          timeout  = "2s"
        }
      }
    }

    network {
      port "registry" {
        static = 5000
      }
    }
  }
}
```

## Service Registration and Routing

The Registry registers itself with Consul and is configured with Traefik routing tags. This enables:

1. Service discovery via Consul
2. Automatic routing via Traefik
3. TLS termination with your self-signed certificates
4. Dashboard integration with Homepage

## Authentication Integration

The Registry can be configured to use Vault for authentication:

```yaml
auth:
  token:
    realm: "https://vault.homelab.local/v1/auth/registry"
    service: "Docker registry"
    issuer: "Vault"
    rootcertbundle: "/etc/registry/vault.pem"
```

Or with direct OIDC integration:

```yaml
auth:
  oidc:
    realm: "https://auth.homelab.local/realms/homelab"
    service: "Docker registry"
    client_id: "registry"
    client_secret: "${OIDC_CLIENT_SECRET}"
    scopes: ["openid", "profile", "email"]
```

## Using the Registry

### Configuring Docker for Self-Signed Certificates

Since you're using self-signed certificates, configure your Docker client to trust them:

```bash
# On client machines:
# Create directory for certificates
sudo mkdir -p /etc/docker/certs.d/registry.homelab.local:5000

# Copy your self-signed certificate
sudo cp homelab.crt /etc/docker/certs.d/registry.homelab.local:5000/ca.crt

# Restart Docker
sudo systemctl restart docker
```

### Pushing Images

To push an image to your private registry:

1. Tag your image with the registry hostname:
   ```bash
   docker tag myimage:latest registry.homelab.local:5000/myimage:latest
   ```

2. Push the image:
   ```bash
   docker push registry.homelab.local:5000/myimage:latest
   ```

### Pulling Images

To pull an image from your private registry:

```bash
docker pull registry.homelab.local:5000/myimage:latest
```

### Using in Nomad Jobs

To use registry images in Nomad jobs:

```hcl
task "app" {
  driver = "docker"
  
  config {
    image = "registry.homelab.local:5000/myimage:latest"
    // ...
  }
}
```

## Memory Optimization for Synology DS923+

With 32GB RAM available on your system, the Registry is configured with adequate resource allocation:

```hcl
resources {
  cpu    = 500   # 0.5 cores
  memory = 512   # 512 MB RAM
}
```

This provides sufficient memory for Registry operations while efficiently using your available resources.

## Registry API

The Docker Registry provides a REST API for managing images. Some useful endpoints:

- **List repositories**: `GET /v2/_catalog`
- **List image tags**: `GET /v2/{name}/tags/list`
- **Delete an image**: `DELETE /v2/{name}/manifests/{reference}`

Example usage:
```bash
curl -X GET https://registry.homelab.local/v2/_catalog
```

## Garbage Collection

Over time, the Registry can accumulate unused layers. To clean up:

1. **Stop Registry**:
   ```bash
   nomad job stop docker-registry
   ```

2. **Run Garbage Collection**:
   ```bash
   nomad alloc exec -task registry <alloc-id> registry garbage-collect /etc/docker/registry/config.yml
   ```

3. **Restart Registry**:
   ```bash
   nomad job run jobs/registry.hcl
   ```

## Security Considerations

For enhanced security:

1. **Enable Authentication**: Integrate with Vault or OIDC
2. **Configure TLS**: Use your self-signed certificates via Traefik 
3. **Restrict Access**: Limit which IPs can access the registry
4. **Regular Backups**: Back up the registry data directory
5. **Image Scanning**: Consider integrating with vulnerability scanning tools

## Integration with Synology Container Manager

While the Registry is deployed through Nomad, you can use it with Synology's Container Manager:

1. **Configure Container Manager to use your registry**:
   - In Container Manager, go to Settings > Registry
   - Add your registry URL: `https://registry.homelab.local:5000`
   - Enter credentials if authentication is enabled

2. **Import images from your registry**:
   - In Container Manager, click "Image"
   - Select "Pull" and enter your registry image path

This allows you to benefit from your private registry while still using Synology's native container tools.

## Monitoring

The Registry exports metrics that can be collected by Prometheus. Key metrics include:

- HTTP request counts and latencies
- Storage operations and durations
- Cache effectiveness
- Authentication success/failure rates

## Logs

Registry logs are:

1. Collected by Promtail
2. Stored in Loki
3. Viewable in Grafana dashboards

You can also view logs directly using:

```bash
nomad alloc logs <registry-alloc-id>
```

## Handling DSM Updates

When updating your Synology DSM:

1. The Registry will typically stop during the update
2. Image data will remain safe in the persistent volume
3. After the update, the Registry will restart automatically
4. Verify the Registry is operational by checking its API endpoint

## Backup and Recovery

### Backup Registry Data

To backup the Registry:

```bash
# Option 1: Using Synology Hyper Backup
# Include /volume1/nomad/volumes/registry_data in your backup task

# Option 2: Manual backup
# Stop the Registry service
nomad job stop docker-registry

# Backup the data directory
tar -czf /volume2/backups/services/registry_backup.tar.gz -C /volume1/nomad/volumes registry_data

# Restart Registry
nomad job run jobs/registry.hcl
```

### Restore Registry Data

To restore from a backup:

```bash
# Stop the Registry service
nomad job stop docker-registry

# Restore the data directory
rm -rf /volume1/nomad/volumes/registry_data/*
tar -xzf /volume2/backups/services/registry_backup.tar.gz -C /volume1/nomad/volumes

# Restart Registry
nomad job run jobs/registry.hcl
```

## Troubleshooting

Common Registry issues and solutions:

1. **Connection Refused**:
   - Verify Registry is running: `nomad job status docker-registry`
   - Check if port 5000 is accessible: `curl -k https://registry.homelab.local:5000/v2/`
   - Ensure the service is registered in Consul

2. **Unable to Push/Pull Images**:
   - Verify Docker is configured to trust your self-signed certificate
   - Check hostname resolution: `ping registry.homelab.local`
   - Ensure Traefik is routing correctly
   - Validate authentication credentials

3. **Storage Issues**:
   - Check disk space: `df -h /volume1/nomad/volumes/registry_data`
   - Verify Registry container has write access to the volume
   - Run garbage collection to reclaim space

4. **API Errors**:
   - Check Registry logs: `nomad alloc logs <registry-alloc-id>`
   - Verify API endpoint formatting
   - Ensure Registry is healthy: `curl -I -k https://registry.homelab.local/v2/`

5. **Authentication Failures**:
   - Check Vault or OIDC configuration
   - Verify client credentials
   - Check Registry auth configuration

## Next Steps

After deploying the Docker Registry, the next step is to set up the monitoring stack. This is covered in [Monitoring Setup](07-monitoring-setup.md).