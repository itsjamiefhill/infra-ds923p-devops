# Vault Setup for Synology DS923+

This document provides detailed information about the HashiCorp Vault component of the HomeLab DevOps Platform for Synology DS923+.

## Overview

HashiCorp Vault is a secrets management tool that secures, stores, and tightly controls access to tokens, passwords, certificates, encryption keys, and other sensitive data. In the HomeLab DevOps Platform, Vault serves as:

- A central secrets storage system
- A certificate management solution
- An authentication and authorization provider
- A key-value store for sensitive configuration

## Architecture

The platform implements Vault in a simplified mode appropriate for a Synology homelab environment:

- **Deployment Mode**: Single server (dev mode is optional for testing)
- **Storage Backend**: File-based storage on persistent volume
- **Auto-unseal**: Optional, but manual unsealing is typically used in homelab
- **UI**: Web interface for secrets management
- **API**: RESTful interface for programmatic access
- **Authentication**: Multiple auth methods including OIDC

## Configuration

Vault configuration is defined in `jobs/vault.hcl`, which is generated by the `05-deploy-vault.sh` script. Key configuration elements include:

| Parameter | Default Value | Description |
|-----------|---------------|-------------|
| HTTP Port | 8200 | API and UI port |
| HTTP Listener | 0.0.0.0:8200 | Address for client connections |
| Disable Mlock | true | Disables memory locking (for containers) |
| UI | true | Enables web interface |
| Storage | file | Local file system storage |
| Log Level | info | Log verbosity level |

## Data Persistence

Vault data is persisted on the Synology NAS using a Nomad volume:
- **Volume Name**: vault_data
- **Host Path**: `/volume1/docker/nomad/volumes/vault_data` (default)
- **Container Path**: `/vault/data`

This ensures that Vault's storage, including encrypted secrets, is maintained across restarts and DSM updates.

## Technical Implementation

The Vault deployment is implemented as a Nomad job with a Docker driver. Here's the job definition structure:

```hcl
job "vault" {
  datacenters = ["dc1"]
  type = "service"

  group "vault" {
    count = 1

    network {
      port "http" {
        static = 8200
      }
    }

    volume "vault_data" {
      type = "host"
      read_only = false
      source = "vault_data"
    }

    task "vault" {
      driver = "docker"

      config {
        image = "hashicorp/vault:latest"
        ports = ["http"]
        
        volumes = [
          "local/vault.hcl:/vault/config/vault.hcl"
        ]
        
        cap_add = [
          "IPC_LOCK"
        ]
      }

      volume_mount {
        volume = "vault_data"
        destination = "/vault/data"
        read_only = false
      }

      template {
        data = <<EOF
storage "file" {
  path = "/vault/data"
}

listener "tcp" {
  address = "0.0.0.0:8200"
  tls_disable = true
}

ui = true
disable_mlock = true
api_addr = "http://{{ env "NOMAD_IP_http" }}:8200"
EOF
        destination = "local/vault.hcl"
      }

      resources {
        cpu    = 500
        memory = 1024
      }

      service {
        name = "vault"
        port = "http"
        
        tags = [
          "traefik.enable=true",
          "traefik.http.routers.vault.rule=Host(`vault.homelab.local`)",
          "traefik.http.routers.vault.tls=true",
          "homepage.name=Vault",
          "homepage.icon=vault.png",
          "homepage.group=Security",
          "homepage.description=Secrets Management"
        ]
        
        check {
          name     = "vault_health"
          type     = "http"
          path     = "/v1/sys/health"
          interval = "10s"
          timeout  = "2s"
        }
      }
    }
  }
}
```

## Initialization and Unsealing

When Vault starts for the first time, it needs to be initialized:

```bash
# Initialize Vault and save the keys and token
nomad alloc exec -task vault <vault-alloc-id> vault operator init > /volume1/docker/nomad/config/vault-init.txt

# Unseal Vault with three unseal keys
nomad alloc exec -task vault <vault-alloc-id> vault operator unseal <key1>
nomad alloc exec -task vault <vault-alloc-id> vault operator unseal <key2>
nomad alloc exec -task vault <vault-alloc-id> vault operator unseal <key3>
```

Important: Store the root token and unseal keys securely! Loss of these will prevent access to your secrets.

## Memory Optimization for Synology DS923+

With 32GB RAM available on your system, Vault is configured with adequate resource allocation:

```hcl
resources {
  cpu    = 500   # 0.5 cores
  memory = 1024  # 1 GB RAM
}
```

This provides sufficient memory for Vault's operations while leaving resources for other services.

## Secret Engines

After initialization, enable the secret engines you need:

```bash
# Export the Vault token
export VAULT_TOKEN=<your-root-token>
export VAULT_ADDR=http://localhost:8200

# Enable the KV version 2 secrets engine
nomad alloc exec -task vault <vault-alloc-id> vault secrets enable -version=2 kv

# Enable PKI for certificate management
nomad alloc exec -task vault <vault-alloc-id> vault secrets enable pki

# Enable database engine for dynamic credentials
nomad alloc exec -task vault <vault-alloc-id> vault secrets enable database

# Enable transit for encryption as a service
nomad alloc exec -task vault <vault-alloc-id> vault secrets enable transit
```

## Auth Methods

Configure authentication methods:

```bash
# Enable AppRole auth for service-to-service authentication
nomad alloc exec -task vault <vault-alloc-id> vault auth enable approle

# Enable OIDC auth for user authentication
nomad alloc exec -task vault <vault-alloc-id> vault auth enable oidc
nomad alloc exec -task vault <vault-alloc-id> vault write auth/oidc/config \
    oidc_discovery_url="https://auth.homelab.local/realms/homelab" \
    oidc_client_id="vault" \
    oidc_client_secret="your-client-secret" \
    default_role="default"

# Configure OIDC role
nomad alloc exec -task vault <vault-alloc-id> vault write auth/oidc/role/default \
    bound_audiences="vault" \
    allowed_redirect_uris="https://vault.homelab.local/ui/vault/auth/oidc/oidc/callback" \
    user_claim="sub" \
    policies="default"
```

## Policies

Create policies to control access to secrets:

```bash
# Create a policy for Traefik
cat <<EOF > traefik-policy.hcl
path "kv/data/traefik/*" {
  capabilities = ["read"]
}
EOF

nomad alloc exec -task vault <vault-alloc-id> vault policy write traefik traefik-policy.hcl

# Create a policy for Grafana
cat <<EOF > grafana-policy.hcl
path "kv/data/grafana/*" {
  capabilities = ["read"]
}
EOF

nomad alloc exec -task vault <vault-alloc-id> vault policy write grafana grafana-policy.hcl
```

## Service Integration

Configure services to fetch secrets from Vault:

```hcl
# In a Nomad job template
template {
  data = <<EOF
{{- with secret "kv/data/grafana/admin" }}
GF_SECURITY_ADMIN_USER={{ .Data.data.username }}
GF_SECURITY_ADMIN_PASSWORD={{ .Data.data.password }}
{{- end }}
EOF
  destination = "secrets/grafana.env"
  env = true
}
```

## Accessing Vault

You can access Vault through multiple interfaces:

1. **Web UI**: `https://vault.homelab.local`
2. **HTTP API**: `https://vault.homelab.local/v1/...`
3. **CLI**: Using the Vault CLI with proper authentication

## TLS Configuration

For production use, configure TLS with your self-signed certificates:

```hcl
listener "tcp" {
  address = "0.0.0.0:8200"
  tls_cert_file = "/vault/certs/homelab.crt"
  tls_key_file = "/vault/certs/homelab.key"
}
```

With Traefik in front of Vault, TLS termination can also be handled at the Traefik level.

## Backup and Recovery

### Data Backup

Vault data should be backed up regularly:

```bash
# Stop Vault
nomad job stop vault

# Backup the data directory
sudo tar -czf /volume2/backups/services/vault_backup.tar.gz -C /volume1/docker/nomad/volumes vault_data

# Restart Vault
nomad job run jobs/vault.hcl

# Unseal Vault again
nomad alloc exec -task vault <vault-alloc-id> vault operator unseal <key1>
nomad alloc exec -task vault <vault-alloc-id> vault operator unseal <key2>
nomad alloc exec -task vault <vault-alloc-id> vault operator unseal <key3>
```

### Synology-specific Backup Strategy

For Synology, you can use Hyper Backup to include the Vault data directory in your regular backups:

1. Create a backup task in Hyper Backup
2. Include `/volume1/docker/nomad/volumes/vault_data` in the backup
3. Configure appropriate schedule and retention policy
4. Consider using the pre-backup script to stop Vault before backup

### Key Management

Your unseal keys and root token are critical assets:

1. **Split Knowledge**: Distribute unseal keys to different trusted individuals
2. **Physical Security**: Consider storing keys in a physical safe or vault
3. **Digital Backup**: Encrypt backups with GPG or other strong encryption
4. **Recovery Plan**: Document the recovery procedure in case of failure

## Monitoring

Vault exports Prometheus metrics that can be collected by the platform's monitoring stack:

```hcl
# In vault.hcl
telemetry {
  prometheus_retention_time = "30s"
  disable_hostname = true
}
```

Key metrics to monitor:
- Seal status
- Token counts
- Request rates
- Lease counts
- Storage backend metrics

## Logging

Vault logs are:

1. Collected by Promtail
2. Stored in Loki
3. Viewable in Grafana dashboards

You can also view logs directly using:

```bash
nomad alloc logs <vault-alloc-id>
```

## Security Considerations

For enhanced security:

1. **Network Segmentation**: Limit which services can access Vault
2. **Audit Logging**: Enable audit logs to track all access
3. **Response Wrapping**: Use response wrapping for sensitive values
4. **Lease Management**: Set appropriate TTLs for secrets
5. **Regular Key Rotation**: Rotate keys and credentials on a schedule

## Handling DSM Updates

When updating your Synology DSM:

1. Vault will typically stop during the update
2. Data will remain safe in the persistent volume
3. After the update, Vault will need to be unsealed again
4. Consider documenting the unsealing procedure for quick recovery

## Integrating with Platform Services

### Traefik Integration

Store Traefik API credentials in Vault:

```bash
nomad alloc exec -task vault <vault-alloc-id> vault kv put kv/traefik/api username=admin password=secure-password
```

### Grafana Integration

Store Grafana admin credentials in Vault:

```bash
nomad alloc exec -task vault <vault-alloc-id> vault kv put kv/grafana/admin username=admin password=secure-password
```

### Database Credentials

For database services, use Vault's database secret engine:

```bash
nomad alloc exec -task vault <vault-alloc-id> vault write database/config/postgres \
    plugin_name=postgresql-database-plugin \
    allowed_roles="*" \
    connection_url="postgresql://{{username}}:{{password}}@postgres:5432/" \
    username="vault" \
    password="vault-password"

nomad alloc exec -task vault <vault-alloc-id> vault write database/roles/readonly \
    db_name=postgres \
    creation_statements="CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; \
        GRANT SELECT ON ALL TABLES IN SCHEMA public TO \"{{name}}\";" \
    default_ttl="1h" \
    max_ttl="24h"
```

## Troubleshooting

Common issues and their solutions:

1. **Vault Sealed**:
   - Check if Vault is sealed: `nomad alloc exec -task vault <vault-alloc-id> vault status`
   - Unseal using the unseal keys
   - Check auto-unseal configuration if enabled

2. **Authentication Failures**:
   - Verify the auth method is correctly configured
   - Check client credentials
   - Ensure the policy allows the requested operation

3. **Permission Denied**:
   - Review the policies assigned to the token
   - Check policy syntax and paths
   - Verify the token hasn't expired

4. **Initialization Issues**:
   - Ensure the storage backend is accessible
   - Check if Vault has already been initialized
   - Verify the config file is correctly formatted

5. **OIDC Problems**:
   - Check OIDC provider configuration
   - Verify redirect URIs
   - Inspect browser console for errors during auth flow

## Next Steps

After deploying Vault, the next step is to set up the Docker Registry. This is covered in [Registry Setup](06-registry-setup.md).